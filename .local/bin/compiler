#!/bin/bash

# This script will compile or run another finishing operation on a document. I
# have this script run via vim.

# Compiles .tex. groff (.mom, .ms), .rmd, .md, .org.	Opens .sent files as sent
# presentations. Runs scripts based on extension or shebang.

file=$(readlink -f -- "${1}")
ext="${file##*.}"
dir=${file%/*}
base="${file%.*}"

cd -- "${dir}" || exit "1"

_md2html() {
	if [[ -x $(command -v md2html) ]]; then
		md2html -f --github "$file" |
		sed '/^<meta .*>$/a <meta charset="utf-8">' > "${base}.html"
	elif [[ -x $(command -v mkd2html) ]]; then
		mkd2html "$file" "${base}.html"
	else
		echo "Install md2html (md4c) or mkd2html (discount)." >&2
		exit 1
	fi
}

case "${ext}" in
	# Try to keep these cases in alphabetical order.
	[0-9]) preconv "${file}" | refer -PS -e | groff -mandoc -T pdf > "${base}.pdf" ;;
	mom|ms) preconv "${file}" | refer -PS -e | groff -T pdf -m"${ext}" > "${base}.pdf" ;;
	c) cc "${file}" -o "${base}" && "./${base}" ;;
	cob) cobc -x -o "$base" "$file" && "$base" ;;
	cpp) g++ "${file}" -o "${base}" && "./${base}" ;;
	cs) mcs "${file}" && mono "${base}.exe" ;;
	go) go run "${file}" ;;
	h) sudo make install ;;
	java) javac -d classes "${file}" && java -cp classes "${base}" ;;
	m) octave "${file}" ;;
	md)
		if [ -x "$(command -v wkhtmltopdf)" ]; then
			_md2html
			# note: image files can be placed in the 'img' directory on in the same directory as $file
			wkhtmltopdf --allow "${dir}" --allow "${dir}/img" "${base}.html" "${base}.pdf"
		elif [ -x "$(command -v groffdown)" ]; then
			groffdown -i "${file}" | groff -T pdf > "${base}.pdf"
		elif [ -x "$(command -v lowdown)" ]; then
			lowdown --parse-no-intraemph "${file}" -Tms | groff -mpdfmark -ms -kept -T pdf > "${base}.pdf"
		else
			pandoc -t ms --highlight-style="kate" -s -o "${base}.pdf" "${file}"
		fi ; ;;
	org) emacs "${file}" --batch -u "${USER}" -f org-latex-export-to-pdf ;;
	py) python "${file}" ;;
	rink) rink -f "${file}" ;;
	[rR]md) Rscript -e "rmarkdown::render('${file}', quiet=TRUE)" ;;
	rs) cargo build ;;
	sass) sassc -a "${file}" "${base}.css" ;;
	scad) openscad -o "${base}.stl" "${file}" ;;
	sent) setsid -f sent "${file}" 2> "/dev/null" ;;
	lua) lua "$file" ;;
	tex) latexmk ;;
	typ)
		typst compile "$file" "${base}.pdf"
		;;
	*) sed -n '/^#!/s/^#!//p; q' "${file}" | xargs -r -I % "${file}" ;;
esac

echo -n "Press any key to continue..."
read -r
